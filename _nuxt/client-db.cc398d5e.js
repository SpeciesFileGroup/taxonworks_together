import{O as R,G as O,Z as N,R as T}from"./entry.425430ac.js";import{g as q,b as M,c as K,s as z,d as x,w as F,f as J,h as Q}from"./query.6c08d7b3.js";import{b as V}from"./path-meta.2fe81d18.js";import{u as D}from"./preview.f563f2e5.js";import"./utils.1cb9591c.js";import"./index.288f722b.js";const G="memory",H=()=>{const r=new Map;return{name:G,options:{},hasItem(e){return r.has(e)},getItem(e){return r.get(e)||null},getItemRaw(e){return r.get(e)||null},setItem(e,n){r.set(e,n)},setItemRaw(e,n){r.set(e,n)},removeItem(e){r.delete(e)},getKeys(){return Array.from(r.keys())},clear(){r.clear()},dispose(){r.clear()}}};function U(r){return!r||typeof r.then!="function"?Promise.resolve(r):r}function h(r,...e){try{return U(r(...e))}catch(n){return Promise.reject(n)}}function X(r){const e=typeof r;return r===null||e!=="object"&&e!=="function"}function Z(r){const e=Object.getPrototypeOf(r);return!e||e.isPrototypeOf(Object)}function A(r){if(X(r))return String(r);if(Z(r)||Array.isArray(r))return JSON.stringify(r);if(typeof r.toJSON=="function")return A(r.toJSON());throw new Error("[unstorage] Cannot stringify value!")}function L(){if(typeof Buffer===void 0)throw new TypeError("[unstorage] Buffer is not supported!")}const j="base64:";function Y(r){if(typeof r=="string")return r;L();const e=Buffer.from(r).toString("base64");return j+e}function b(r){return typeof r!="string"||!r.startsWith(j)?r:(L(),Buffer.from(r.slice(j.length),"base64"))}const k=["hasItem","getItem","getItemRaw","setItem","setItemRaw","removeItem","getMeta","setMeta","removeMeta","getKeys","clear","mount","unmount"];function tt(r,e){if(e=$(e),!e)return r;const n={...r};for(const i of k)n[i]=(o="",...c)=>r[i](e+o,...c);return n.getKeys=(i="",...o)=>r.getKeys(e+i,...o).then(c=>c.map(l=>l.slice(e.length))),n}function w(r){return r?r.split("?")[0].replace(/[/\\]/g,":").replace(/:+/g,":").replace(/^:|:$/g,""):""}function et(...r){return w(r.join(":"))}function $(r){return r=w(r),r?r+":":""}const rt="memory",nt=()=>{const r=new Map;return{name:rt,options:{},hasItem(e){return r.has(e)},getItem(e){return r.get(e)||null},getItemRaw(e){return r.get(e)||null},setItem(e,n){r.set(e,n)},setItemRaw(e,n){r.set(e,n)},removeItem(e){r.delete(e)},getKeys(){return Array.from(r.keys())},clear(){r.clear()},dispose(){r.clear()}}};function it(r={}){const e={mounts:{"":r.driver||nt()},mountpoints:[""],watching:!1,watchListeners:[],unwatch:{}},n=t=>{for(const s of e.mountpoints)if(t.startsWith(s))return{base:s,relativeKey:t.slice(s.length),driver:e.mounts[s]};return{base:"",relativeKey:t,driver:e.mounts[""]}},i=(t,s)=>e.mountpoints.filter(a=>a.startsWith(t)||s&&t.startsWith(a)).map(a=>({relativeBase:t.length>a.length?t.slice(a.length):void 0,mountpoint:a,driver:e.mounts[a]})),o=(t,s)=>{if(e.watching){s=w(s);for(const a of e.watchListeners)a(t,s)}},c=async()=>{if(!e.watching){e.watching=!0;for(const t in e.mounts)e.unwatch[t]=await E(e.mounts[t],o,t)}},l=async()=>{if(e.watching){for(const t in e.unwatch)await e.unwatch[t]();e.unwatch={},e.watching=!1}},p=(t,s,a)=>{const u=new Map,f=m=>{let y=u.get(m.base);return y||(y={driver:m.driver,base:m.base,items:[]},u.set(m.base,y)),y};for(const m of t){const y=typeof m=="string",v=w(y?m:m.key),d=y?void 0:m.value,I=y||!m.options?s:{...s,...m.options},_=n(v);f(_).items.push({key:v,value:d,relativeKey:_.relativeKey,options:I})}return Promise.all([...u.values()].map(m=>a(m))).then(m=>m.flat())},g={hasItem(t,s={}){t=w(t);const{relativeKey:a,driver:u}=n(t);return h(u.hasItem,a,s)},getItem(t,s={}){t=w(t);const{relativeKey:a,driver:u}=n(t);return h(u.getItem,a,s).then(f=>R(f))},getItems(t,s){return p(t,s,a=>a.driver.getItems?h(a.driver.getItems,a.items.map(u=>({key:u.relativeKey,options:u.options})),s).then(u=>u.map(f=>({key:et(a.base,f.key),value:R(f.value)}))):Promise.all(a.items.map(u=>h(a.driver.getItem,u.relativeKey,u.options).then(f=>({key:u.key,value:R(f)})))))},getItemRaw(t,s={}){t=w(t);const{relativeKey:a,driver:u}=n(t);return u.getItemRaw?h(u.getItemRaw,a,s):h(u.getItem,a,s).then(f=>b(f))},async setItem(t,s,a={}){if(s===void 0)return g.removeItem(t);t=w(t);const{relativeKey:u,driver:f}=n(t);f.setItem&&(await h(f.setItem,u,A(s),a),f.watch||o("update",t))},async setItems(t,s){await p(t,s,async a=>{a.driver.setItems&&await h(a.driver.setItems,a.items.map(u=>({key:u.relativeKey,value:A(u.value),options:u.options})),s),a.driver.setItem&&await Promise.all(a.items.map(u=>h(a.driver.setItem,u.relativeKey,A(u.value),u.options)))})},async setItemRaw(t,s,a={}){if(s===void 0)return g.removeItem(t,a);t=w(t);const{relativeKey:u,driver:f}=n(t);if(f.setItemRaw)await h(f.setItemRaw,u,s,a);else if(f.setItem)await h(f.setItem,u,Y(s),a);else return;f.watch||o("update",t)},async removeItem(t,s={}){typeof s=="boolean"&&(s={removeMeta:s}),t=w(t);const{relativeKey:a,driver:u}=n(t);u.removeItem&&(await h(u.removeItem,a,s),(s.removeMeta||s.removeMata)&&await h(u.removeItem,a+"$",s),u.watch||o("remove",t))},async getMeta(t,s={}){typeof s=="boolean"&&(s={nativeOnly:s}),t=w(t);const{relativeKey:a,driver:u}=n(t),f=Object.create(null);if(u.getMeta&&Object.assign(f,await h(u.getMeta,a,s)),!s.nativeOnly){const m=await h(u.getItem,a+"$",s).then(y=>R(y));m&&typeof m=="object"&&(typeof m.atime=="string"&&(m.atime=new Date(m.atime)),typeof m.mtime=="string"&&(m.mtime=new Date(m.mtime)),Object.assign(f,m))}return f},setMeta(t,s,a={}){return this.setItem(t+"$",s,a)},removeMeta(t,s={}){return this.removeItem(t+"$",s)},async getKeys(t,s={}){t=$(t);const a=i(t,!0);let u=[];const f=[];for(const m of a){const v=(await h(m.driver.getKeys,m.relativeBase,s)).map(d=>m.mountpoint+w(d)).filter(d=>!u.some(I=>d.startsWith(I)));f.push(...v),u=[m.mountpoint,...u.filter(d=>!d.startsWith(m.mountpoint))]}return t?f.filter(m=>m.startsWith(t)&&!m.endsWith("$")):f.filter(m=>!m.endsWith("$"))},async clear(t,s={}){t=$(t),await Promise.all(i(t,!1).map(async a=>{if(a.driver.clear)return h(a.driver.clear,a.relativeBase,s);if(a.driver.removeItem){const u=await a.driver.getKeys(a.relativeBase||"",s);return Promise.all(u.map(f=>a.driver.removeItem(f,s)))}}))},async dispose(){await Promise.all(Object.values(e.mounts).map(t=>B(t)))},async watch(t){return await c(),e.watchListeners.push(t),async()=>{e.watchListeners=e.watchListeners.filter(s=>s!==t),e.watchListeners.length===0&&await l()}},async unwatch(){e.watchListeners=[],await l()},mount(t,s){if(t=$(t),t&&e.mounts[t])throw new Error(`already mounted at ${t}`);return t&&(e.mountpoints.push(t),e.mountpoints.sort((a,u)=>u.length-a.length)),e.mounts[t]=s,e.watching&&Promise.resolve(E(s,o,t)).then(a=>{e.unwatch[t]=a}).catch(console.error),g},async unmount(t,s=!0){t=$(t),!(!t||!e.mounts[t])&&(e.watching&&t in e.unwatch&&(e.unwatch[t](),delete e.unwatch[t]),s&&await B(e.mounts[t]),e.mountpoints=e.mountpoints.filter(a=>a!==t),delete e.mounts[t])},getMount(t=""){t=w(t)+":";const s=n(t);return{driver:s.driver,base:s.base}},getMounts(t="",s={}){return t=w(t),i(t,s.parents).map(u=>({driver:u.driver,base:u.mountpoint}))}};return g}function E(r,e,n){return r.watch?r.watch((i,o)=>e(i,n+o)):()=>{}}async function B(r){typeof r.dispose=="function"&&await h(r.dispose)}function st(r={}){const e=at(n,r.operators);function n(i,o){return typeof o!="object"||o instanceof RegExp?e.$eq(i,o):Object.keys(o||{}).every(c=>{const l=o[c];if(c.startsWith("$")&&e[c]){const p=e[c];return typeof p=="function"?p(i,l):!1}return n(q(i,c),l)})}return n}function at(r,e={}){return{$match:(n,i)=>r(n,i),$eq:(n,i)=>i instanceof RegExp?i.test(n):n===i,$ne:(n,i)=>i instanceof RegExp?!i.test(n):n!==i,$not:(n,i)=>!r(n,i),$and:(n,i)=>(M(i,"$and requires an array as condition"),i.every(o=>r(n,o))),$or:(n,i)=>(M(i,"$or requires an array as condition"),i.some(o=>r(n,o))),$in:(n,i)=>K(i).some(o=>Array.isArray(n)?r(n,{$contains:o}):r(n,o)),$contains:(n,i)=>(n=Array.isArray(n)?n:String(n),K(i).every(o=>n.includes(o))),$icontains:(n,i)=>{if(typeof i!="string")throw new TypeError("$icontains requires a string, use $contains instead");return n=String(n).toLocaleLowerCase(),K(i).every(o=>n.includes(o.toLocaleLowerCase()))},$containsAny:(n,i)=>(M(i,"$containsAny requires an array as condition"),n=Array.isArray(n)?n:String(n),i.some(o=>n.includes(o))),$exists:(n,i)=>i?typeof n<"u":typeof n>"u",$type:(n,i)=>typeof n===String(i),$regex:(n,i)=>{if(!(i instanceof RegExp)){const o=String(i).match(/\/(.*)\/([dgimsuy]*)$/);i=o?new RegExp(o[1],o[2]||""):new RegExp(i)}return i.test(String(n||""))},$lt:(n,i)=>n<i,$lte:(n,i)=>n<=i,$gt:(n,i)=>n>i,$gte:(n,i)=>n>=i,...e||{}}}function C(r){const e=st(),n=(o,{query:c,before:l,after:p})=>{const g=typeof c=="string"?{_path:c}:c,t=o.findIndex(a=>e(a,g));l=l??1,p=p??1;const s=new Array(l+p).fill(null,0);return t===-1?s:s.map((a,u)=>o[t-l+u+ +(u>=l)]||null)},i=[(o,c)=>o.filter(l=>K(c.where).every(p=>e(l,p))),(o,c)=>K(c.sort).forEach(l=>z(o,l)),(o,c)=>c.surround?n(o,c.surround):o,(o,c)=>c.skip?o.slice(c.skip):o,(o,c)=>c.limit?o.slice(0,c.limit):o,(o,c)=>x(F(c.without))(o),(o,c)=>x(J(c.only))(o)];return async o=>{const c=await r(),l=o.params(),p=i.reduce((g,t)=>t(g,l)||g,c);return l.first?p[0]:p}}function ot(r,e){const{navigation:n}=O().public.content,i=c=>({...ut(["title",...n.fields])(c),...ft(c==null?void 0:c.navigation)?c.navigation:{}}),o=r.sort((c,l)=>c._path.localeCompare(l._path)).reduce((c,l)=>{const p=l._path.substring(1).split("/"),g=l._id.split(":").slice(1),t=!!g[g.length-1].match(/([1-9][0-9]*\.)?index.md/g),s=f=>({title:f.title,_path:f._path,_file:f._file,children:[],...i(f),...f._draft?{_draft:!0}:{}}),a=s(l);if(t){const f=e[a._path];if(typeof(f==null?void 0:f.navigation)<"u"&&!(f!=null&&f.navigation))return c;if(l._path!=="/"){const m=s(l);a.children.push(m)}Object.assign(a,i(f))}return p.length===1?(c.push(a),c):(p.slice(0,-1).reduce((f,m,y)=>{const v="/"+p.slice(0,y+1).join("/"),d=e[v];if(typeof(d==null?void 0:d.navigation)<"u"&&!d.navigation)return[];let I=f.find(_=>_._path===v);return I||(I={title:V(m),_path:v,_file:l._file,children:[],...i(d)},f.push(I)),I.children},c).push(a),c)},[]);return W(o)}const ct=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});function W(r){var n;const e=r.sort((i,o)=>ct.compare(i._file,o._file));for(const i of e)(n=i.children)!=null&&n.length?W(i.children):delete i.children,delete i._file;return r}function ut(r){return e=>(e=e||{},r&&r.length?r.filter(n=>typeof e[n]<"u").reduce((n,i)=>Object.assign(n,{[i]:e[i]}),{}):e)}function ft(r){return Object.prototype.toString.call(r)==="[object Object]"}const lt=r=>N(r,O().public.content.api.baseURL),mt=tt(it({driver:H()}),"@content");function gt(r){async function e(){const n=new Set(await r.getKeys("cache:")),i=D().getPreviewToken();if(i){const c=await r.getItem(`${i}$`).then(g=>g||{});if(Array.isArray(c.ignoreSources)){const g=c.ignoreSources.map(t=>`cache:${t.trim()}:`);for(const t of n)g.some(s=>t.startsWith(s))&&n.delete(t)}const l=await r.getKeys(`${i}:`),p=await Promise.all(l.map(g=>r.getItem(g)));for(const g of p)n.delete(`cache:${g._id}`),g.__deleted||n.add(`${i}:${g._id}`)}return await Promise.all(Array.from(n).map(c=>r.getItem(c)))}return{storage:r,fetch:C(e),query:n=>Q(C(e),n)}}let S=null,P=null;async function pt(){return P?await P:S||(P=ht(),S=await P),S}async function ht(){const r=T(),{content:e}=O().public,n=gt(mt),i=await n.storage.getItem("integrity");if(e.integrity!==+(i||0)){const{contents:o,navigation:c}=await $fetch(lt(e.integrity?`cache.${e.integrity}.json`:"cache.json"));await Promise.all(o.map(l=>n.storage.setItem(`cache:${l._id}`,l))),await n.storage.setItem("navigation",c),await n.storage.setItem("integrity",e.integrity)}return await r.callHook("content:storage",n.storage),n}async function Kt(r){const e=await pt();if(!D().getPreviewToken()&&Object.keys(r||{}).length===0)return e.storage.getItem("navigation");const n=await e.query(r).where({_partial:!1,navigation:{$ne:!1}}).find(),o=(await e.query().where({_path:/\/_dir$/i,_partial:!0}).find()).reduce((c,l)=>{var g;((g=l.title)==null?void 0:g.toLowerCase())==="dir"&&(l.title=void 0);const p=l._path.split("/").slice(0,-1).join("/")||"/";return c[p]={...l,...l.body},c},{});return ot(n,o)}export{mt as contentStorage,gt as createDB,Kt as generateNavigation,pt as useContentDatabase};
