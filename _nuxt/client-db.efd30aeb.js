import{C as M,l as O,D as N,z as T}from"./entry.095c2bc9.js";import{g as q,b as R,c as I,s as z,d as S,w as F,f as J,i as Q}from"./query.4e895914.js";import{b as V}from"./path-meta.5c6f05a5.js";import{u as C}from"./preview.e70a5cd9.js";import"./utils.f004c1ec.js";import"./index.288f722b.js";const b="memory",H=()=>{const r=new Map;return{name:b,options:{},hasItem(e){return r.has(e)},getItem(e){return r.get(e)||null},getItemRaw(e){return r.get(e)||null},setItem(e,n){r.set(e,n)},setItemRaw(e,n){r.set(e,n)},removeItem(e){r.delete(e)},getKeys(){return Array.from(r.keys())},clear(){r.clear()},dispose(){r.clear()}}};function U(r){return!r||typeof r.then!="function"?Promise.resolve(r):r}function h(r,...e){try{return U(r(...e))}catch(n){return Promise.reject(n)}}function X(r){const e=typeof r;return r===null||e!=="object"&&e!=="function"}function G(r){const e=Object.getPrototypeOf(r);return!e||e.isPrototypeOf(Object)}function D(r){if(X(r))return String(r);if(G(r)||Array.isArray(r))return JSON.stringify(r);if(typeof r.toJSON=="function")return D(r.toJSON());throw new Error("[unstorage] Cannot stringify value!")}function B(){if(typeof Buffer===void 0)throw new TypeError("[unstorage] Buffer is not supported!")}const P="base64:";function Y(r){if(typeof r=="string")return r;B();const e=Buffer.from(r).toString("base64");return P+e}function Z(r){return typeof r!="string"||!r.startsWith(P)?r:(B(),Buffer.from(r.slice(P.length),"base64"))}const k=["hasItem","getItem","getItemRaw","setItem","setItemRaw","removeItem","getMeta","setMeta","removeMeta","getKeys","clear","mount","unmount"];function tt(r,e){if(e=v(e),!e)return r;const n={...r};for(const i of k)n[i]=(a="",...o)=>r[i](e+a,...o);return n.getKeys=(i="",...a)=>r.getKeys(e+i,...a).then(o=>o.map(f=>f.slice(e.length))),n}function p(r){return r?r.split("?")[0].replace(/[/\\]/g,":").replace(/:+/g,":").replace(/^:|:$/g,""):""}function v(r){return r=p(r),r?r+":":""}const et="memory",rt=()=>{const r=new Map;return{name:et,options:{},hasItem(e){return r.has(e)},getItem(e){return r.get(e)||null},getItemRaw(e){return r.get(e)||null},setItem(e,n){r.set(e,n)},setItemRaw(e,n){r.set(e,n)},removeItem(e){r.delete(e)},getKeys(){return Array.from(r.keys())},clear(){r.clear()},dispose(){r.clear()}}};function nt(r={}){const e={mounts:{"":r.driver||rt()},mountpoints:[""],watching:!1,watchListeners:[],unwatch:{}},n=t=>{for(const s of e.mountpoints)if(t.startsWith(s))return{base:s,relativeKey:t.slice(s.length),driver:e.mounts[s]};return{base:"",relativeKey:t,driver:e.mounts[""]}},i=(t,s)=>e.mountpoints.filter(c=>c.startsWith(t)||s&&t.startsWith(c)).map(c=>({relativeBase:t.length>c.length?t.slice(c.length):void 0,mountpoint:c,driver:e.mounts[c]})),a=(t,s)=>{if(e.watching){s=p(s);for(const c of e.watchListeners)c(t,s)}},o=async()=>{if(!e.watching){e.watching=!0;for(const t in e.mounts)e.unwatch[t]=await j(e.mounts[t],a,t)}},f=async()=>{if(e.watching){for(const t in e.unwatch)await e.unwatch[t]();e.unwatch={},e.watching=!1}},g={hasItem(t,s={}){t=p(t);const{relativeKey:c,driver:u}=n(t);return h(u.hasItem,c,s)},getItem(t,s={}){t=p(t);const{relativeKey:c,driver:u}=n(t);return h(u.getItem,c,s).then(m=>M(m))},getItemRaw(t,s={}){t=p(t);const{relativeKey:c,driver:u}=n(t);return u.getItemRaw?h(u.getItemRaw,c,s):h(u.getItem,c,s).then(m=>Z(m))},async setItem(t,s,c={}){if(s===void 0)return g.removeItem(t);t=p(t);const{relativeKey:u,driver:m}=n(t);m.setItem&&(await h(m.setItem,u,D(s),c),m.watch||a("update",t))},async setItemRaw(t,s,c={}){if(s===void 0)return g.removeItem(t,c);t=p(t);const{relativeKey:u,driver:m}=n(t);if(m.setItemRaw)await h(m.setItemRaw,u,s,c);else if(m.setItem)await h(m.setItem,u,Y(s),c);else return;m.watch||a("update",t)},async removeItem(t,s={}){typeof s=="boolean"&&(s={removeMata:s}),t=p(t);const{relativeKey:c,driver:u}=n(t);u.removeItem&&(await h(u.removeItem,c,s),s.removeMata&&await h(u.removeItem,c+"$",s),u.watch||a("remove",t))},async getMeta(t,s={}){typeof s=="boolean"&&(s={nativeOnly:s}),t=p(t);const{relativeKey:c,driver:u}=n(t),m=Object.create(null);if(u.getMeta&&Object.assign(m,await h(u.getMeta,c,s)),!s.nativeOnly){const l=await h(u.getItem,c+"$",s).then(d=>M(d));l&&typeof l=="object"&&(typeof l.atime=="string"&&(l.atime=new Date(l.atime)),typeof l.mtime=="string"&&(l.mtime=new Date(l.mtime)),Object.assign(m,l))}return m},setMeta(t,s,c={}){return this.setItem(t+"$",s,c)},removeMeta(t,s={}){return this.removeItem(t+"$",s)},async getKeys(t,s={}){t=v(t);const c=i(t,!0);let u=[];const m=[];for(const l of c){const K=(await h(l.driver.getKeys,l.relativeBase,s)).map(w=>l.mountpoint+p(w)).filter(w=>!u.some(y=>w.startsWith(y)));m.push(...K),u=[l.mountpoint,...u.filter(w=>!w.startsWith(l.mountpoint))]}return t?m.filter(l=>l.startsWith(t)&&!l.endsWith("$")):m.filter(l=>!l.endsWith("$"))},async clear(t,s={}){t=v(t),await Promise.all(i(t,!1).map(async c=>{if(c.driver.clear)return h(c.driver.clear,c.relativeBase,s);if(c.driver.removeItem){const u=await c.driver.getKeys(c.relativeBase,s);return Promise.all(u.map(m=>c.driver.removeItem(m)))}}))},async dispose(){await Promise.all(Object.values(e.mounts).map(t=>x(t)))},async watch(t){return await o(),e.watchListeners.push(t),async()=>{e.watchListeners=e.watchListeners.filter(s=>s!==t),e.watchListeners.length===0&&await f()}},async unwatch(){e.watchListeners=[],await f()},mount(t,s){if(t=v(t),t&&e.mounts[t])throw new Error(`already mounted at ${t}`);return t&&(e.mountpoints.push(t),e.mountpoints.sort((c,u)=>u.length-c.length)),e.mounts[t]=s,e.watching&&Promise.resolve(j(s,a,t)).then(c=>{e.unwatch[t]=c}).catch(console.error),g},async unmount(t,s=!0){t=v(t),!(!t||!e.mounts[t])&&(e.watching&&t in e.unwatch&&(e.unwatch[t](),delete e.unwatch[t]),s&&await x(e.mounts[t]),e.mountpoints=e.mountpoints.filter(c=>c!==t),delete e.mounts[t])},getMount(t=""){t=p(t)+":";const s=n(t);return{driver:s.driver,base:s.base}},getMounts(t="",s={}){return t=p(t),i(t,s.parents).map(u=>({driver:u.driver,base:u.mountpoint}))}};return g}function j(r,e,n){return r.watch?r.watch((i,a)=>e(i,n+a)):()=>{}}async function x(r){typeof r.dispose=="function"&&await h(r.dispose)}function it(r={}){const e=st(n,r.operators);function n(i,a){return typeof a!="object"||a instanceof RegExp?e.$eq(i,a):Object.keys(a||{}).every(o=>{const f=a[o];if(o.startsWith("$")&&e[o]){const g=e[o];return typeof g=="function"?g(i,f):!1}return n(q(i,o),f)})}return n}function st(r,e={}){return{$match:(n,i)=>r(n,i),$eq:(n,i)=>i instanceof RegExp?i.test(n):n===i,$ne:(n,i)=>i instanceof RegExp?!i.test(n):n!==i,$not:(n,i)=>!r(n,i),$and:(n,i)=>(R(i,"$and requires an array as condition"),i.every(a=>r(n,a))),$or:(n,i)=>(R(i,"$or requires an array as condition"),i.some(a=>r(n,a))),$in:(n,i)=>I(i).some(a=>Array.isArray(n)?r(n,{$contains:a}):r(n,a)),$contains:(n,i)=>(n=Array.isArray(n)?n:String(n),I(i).every(a=>n.includes(a))),$icontains:(n,i)=>{if(typeof i!="string")throw new TypeError("$icontains requires a string, use $contains instead");return n=String(n).toLocaleLowerCase(),I(i).every(a=>n.includes(a.toLocaleLowerCase()))},$containsAny:(n,i)=>(R(i,"$containsAny requires an array as condition"),n=Array.isArray(n)?n:String(n),i.some(a=>n.includes(a))),$exists:(n,i)=>i?typeof n<"u":typeof n>"u",$type:(n,i)=>typeof n===String(i),$regex:(n,i)=>{if(!(i instanceof RegExp)){const a=String(i).match(/\/(.*)\/([dgimsuy]*)$/);i=a?new RegExp(a[1],a[2]||""):new RegExp(i)}return i.test(String(n||""))},$lt:(n,i)=>n<i,$lte:(n,i)=>n<=i,$gt:(n,i)=>n>i,$gte:(n,i)=>n>=i,...e||{}}}function E(r){const e=it(),n=(a,{query:o,before:f,after:g})=>{const t=typeof o=="string"?{_path:o}:o,s=a.findIndex(u=>e(u,t));f=f??1,g=g??1;const c=new Array(f+g).fill(null,0);return s===-1?c:c.map((u,m)=>a[s-f+m+ +(m>=f)]||null)},i=[(a,o)=>a.filter(f=>I(o.where).every(g=>e(f,g))),(a,o)=>I(o.sort).forEach(f=>z(a,f)),(a,o)=>o.surround?n(a,o.surround):a,(a,o)=>o.skip?a.slice(o.skip):a,(a,o)=>o.limit?a.slice(0,o.limit):a,(a,o)=>S(F(o.without))(a),(a,o)=>S(J(o.only))(a)];return async a=>{const o=await r(),f=a.params(),g=i.reduce((t,s)=>s(t,f)||t,o);return f.first?g[0]:g}}function at(r,e){const{navigation:n}=O().public.content,i=o=>({...ct(["title",...n.fields])(o),...ut(o==null?void 0:o.navigation)?o.navigation:{}}),a=r.sort((o,f)=>o._path.localeCompare(f._path)).reduce((o,f)=>{const g=f._path.substring(1).split("/"),t=f._id.split(":").slice(1),s=!!t[t.length-1].match(/([1-9][0-9]*\.)?index.md/g),c=l=>({title:l.title,_path:l._path,_file:l._file,children:[],...i(l),...l._draft?{_draft:!0}:{}}),u=c(f);if(s){const l=e[u._path];if(typeof(l==null?void 0:l.navigation)<"u"&&!(l!=null&&l.navigation))return o;if(f._path!=="/"){const d=c(f);u.children.push(d)}Object.assign(u,i(l))}return g.length===1?(o.push(u),o):(g.slice(0,-1).reduce((l,d,K)=>{const w="/"+g.slice(0,K+1).join("/"),y=e[w];if(typeof(y==null?void 0:y.navigation)<"u"&&!y.navigation)return[];let $=l.find(W=>W._path===w);return $||($={title:V(d),_path:w,_file:f._file,children:[],...i(y)},l.push($)),$.children},o).push(u),o)},[]);return L(a)}const ot=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});function L(r){var n;const e=r.sort((i,a)=>ot.compare(i._file,a._file));for(const i of e)(n=i.children)!=null&&n.length?L(i.children):delete i.children,delete i._file;return r}function ct(r){return e=>(e=e||{},r&&r.length?r.filter(n=>typeof e[n]<"u").reduce((n,i)=>Object.assign(n,{[i]:e[i]}),{}):e)}function ut(r){return Object.prototype.toString.call(r)==="[object Object]"}const ft=r=>T(r,O().public.content.api.baseURL),lt=tt(nt({driver:H()}),"@content");function mt(r){async function e(){const n=new Set(await r.getKeys("cache:")),i=C().getPreviewToken();if(i){const o=await r.getItem(`${i}$`).then(t=>t||{});if(Array.isArray(o.ignoreSources)){const t=o.ignoreSources.map(s=>`cache:${s.trim()}:`);for(const s of n)t.some(c=>s.startsWith(c))&&n.delete(s)}const f=await r.getKeys(`${i}:`),g=await Promise.all(f.map(t=>r.getItem(t)));for(const t of g)n.delete(`cache:${t._id}`),t.__deleted||n.add(`${i}:${t._id}`)}return await Promise.all(Array.from(n).map(o=>r.getItem(o)))}return{storage:r,fetch:E(e),query:n=>Q(E(e),n)}}let A=null,_=null;async function gt(){return _?await _:A||(_=ht(),A=await _),A}async function ht(){const r=N(),{content:e}=O().public,n=mt(lt),i=await n.storage.getItem("integrity");if(e.integrity!==+(i||0)){const{contents:a,navigation:o}=await $fetch(ft(e.integrity?`cache.${e.integrity}.json`:"cache.json"));await Promise.all(a.map(f=>n.storage.setItem(`cache:${f._id}`,f))),await n.storage.setItem("navigation",o),await n.storage.setItem("integrity",e.integrity)}return await r.callHook("content:storage",n.storage),n}async function $t(r){const e=await gt();if(!C().getPreviewToken()&&Object.keys(r||{}).length===0)return e.storage.getItem("navigation");const n=await e.query(r).where({_partial:!1,navigation:{$ne:!1}}).find(),a=(await e.query().where({_path:/\/_dir$/i,_partial:!0}).find()).reduce((o,f)=>{var t;((t=f.title)==null?void 0:t.toLowerCase())==="dir"&&(f.title=void 0);const g=f._path.split("/").slice(0,-1).join("/")||"/";return o[g]={...f,...f.body},o},{});return at(n,a)}export{lt as contentStorage,mt as createDB,$t as generateNavigation,gt as useContentDatabase};
